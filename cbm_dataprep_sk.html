<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 3 CBM_dataPrep_SK | CBM Spades Manual</title>
<meta name="author" content="Céline Boisvenue">
<meta name="description" content="This documentation is work in progress. Potential discrepancies and omissions may exist for the time being. If you find any regarding this module, contact us here.  3.1 Overview CBM_dataPrep_SK...">
<meta name="generator" content="bookdown 0.42 with bs4_book()">
<meta property="og:title" content="Chapter 3 CBM_dataPrep_SK | CBM Spades Manual">
<meta property="og:type" content="book">
<meta property="og:description" content="This documentation is work in progress. Potential discrepancies and omissions may exist for the time being. If you find any regarding this module, contact us here.  3.1 Overview CBM_dataPrep_SK...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 3 CBM_dataPrep_SK | CBM Spades Manual">
<meta name="twitter:description" content="This documentation is work in progress. Potential discrepancies and omissions may exist for the time being. If you find any regarding this module, contact us here.  3.1 Overview CBM_dataPrep_SK...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.9.0/transition.js"></script><script src="libs/bs3compat-0.9.0/tabs.js"></script><script src="libs/bs3compat-0.9.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="css/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="v. 0.1">CBM Spades Manual</a>:
        <small class="text-muted">v. 0.1</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> About</a></li>
<li><a class="" href="cbm_defaults.html"><span class="header-section-number">2</span> CBM_defaults</a></li>
<li><a class="active" href="cbm_dataprep_sk.html"><span class="header-section-number">3</span> CBM_dataPrep_SK</a></li>
<li><a class="" href="cbm_vol2biomass.html"><span class="header-section-number">4</span> CBM_vol2biomass</a></li>
<li><a class="" href="cbm_core.html"><span class="header-section-number">5</span> CBM_core</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/camillegiuliano/CBMspadesManual">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="cbm_dataprep_sk" class="section level1" number="3">
<h1>
<span class="header-section-number">3</span> CBM_dataPrep_SK<a class="anchor" aria-label="anchor" href="#cbm_dataprep_sk"><i class="fas fa-link"></i></a>
</h1>
<div class="rmdimportant">
<p>This documentation is work in progress. Potential discrepancies and omissions may exist for the time being. If you find any regarding this module, contact us <a href="%22https://github.com/PredictiveEcology/CBM_datPrep_SK/issues%22">here</a>.</p>
</div>
<div id="overview-1" class="section level2" number="3.1">
<h2>
<span class="header-section-number">3.1</span> Overview<a class="anchor" aria-label="anchor" href="#overview-1"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://github.com/PredictiveEcology/CBM_dataPrep_SK.git">CBM_dataPrep_SK</a> processes spatially explicit inputs for use in <a href="https://github.com/PredictiveEcology/CBM_vol2biomass.git">CBM_vol2biomass</a> and <a href="https://github.com/PredictiveEcology/CBM_core.git">CBM_core</a>. In <em>SpaDES-speak</em>, it has one event (<code>init</code>).<a href="https://SpaDES.PredictiveEcology.org">SpaDES</a> was designed for spatially explicit modelling and provides a wide variety of tools to support it. <a href="https://github.com/PredictiveEcology/CBM_dataPrep_SK.git">CBM_dataPrep_SK</a> processes spatially explicit inputs for <a href="https://github.com/PredictiveEcology/spadesCBM.git">spadesCBM</a>, making use of these tools. This information is study area and scenario specific making <a href="https://github.com/PredictiveEcology/CBM_dataPrep_SK.git">CBM_dataPrep_SK</a> the most idiosyncratic module of the <a href="https://github.com/PredictiveEcology/spadesCBM.git">spadesCBM</a> deck. Users have the capacity to define their simulation through the inputs they provide to <a href="https://github.com/PredictiveEcology/CBM_dataPrep_SK.git">CBM_dataPrep_SK</a>. The default example simulates a present day (1985-2011) scenario where remotely-sensed disturbances are simulated in the managed forests of Saskatchewan, as described in <span class="citation">(<a href="#ref-boisvenue2016"><strong>boisvenue2016?</strong></a>)</span>’s (scenario = time horizon + disturbances).</p>
</div>
<div id="inputs" class="section level2" number="3.2">
<h2>
<span class="header-section-number">3.2</span> Inputs<a class="anchor" aria-label="anchor" href="#inputs"><i class="fas fa-link"></i></a>
</h2>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="23%">
<col width="23%">
<col width="29%">
<col width="23%">
</colgroup>
<thead><tr class="header">
<th>Name</th>
<th>Class</th>
<th>Description</th>
<th>Source</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>dMatrixAssociation</td>
<td>Data table</td>
<td>Default disturbance IDs</td>
<td>CBM_defaults</td>
</tr>
<tr class="even">
<td>spinupSQL</td>
<td>Data table</td>
<td>Parameters for CBM_core spinup event</td>
<td>CBM_defaults</td>
</tr>
<tr class="odd">
<td>species_tr</td>
<td>Data table</td>
<td>Default species data</td>
<td>CBM_defaults</td>
</tr>
<tr class="even">
<td>gcMeta</td>
<td>Data table</td>
<td>Species and growth curve IDs</td>
<td><a href="https://drive.google.com/file/d/189SFlySTt0Zs6k57-PzQMuQ29LmycDmJ/view?usp=sharing" class="uri">https://drive.google.com/file/d/189SFlySTt0Zs6k57-PzQMuQ29LmycDmJ/view?usp=sharing</a></td>
</tr>
<tr class="odd">
<td>userGcM3</td>
<td>Data table</td>
<td>User provided growth curve data</td>
<td><a href="https://drive.google.com/file/d/1u7o2BzPZ2Bo7hNcC8nEctNpDmp7ce84m" class="uri">https://drive.google.com/file/d/1u7o2BzPZ2Bo7hNcC8nEctNpDmp7ce84m</a></td>
</tr>
<tr class="even">
<td>masterRaster</td>
<td>SpatRaster</td>
<td>Raster of study area</td>
<td>User provided, for SK: <a href="https://drive.google.com/file/d/1zUyFH8k6Ef4c_GiWMInKbwAl6m6gvLJW" class="uri">https://drive.google.com/file/d/1zUyFH8k6Ef4c_GiWMInKbwAl6m6gvLJW</a>
</td>
</tr>
<tr class="odd">
<td>ageRaster</td>
<td>SpatRaster</td>
<td>Raster ages for each pixel</td>
<td><a href="https://drive.google.com/file/d/1hylk0D1vO19Dpg4zFtnSNhnyYP4j-bEA" class="uri">https://drive.google.com/file/d/1hylk0D1vO19Dpg4zFtnSNhnyYP4j-bEA</a></td>
</tr>
<tr class="even">
<td>gcIndexRaster</td>
<td>SpatRaster</td>
<td>Raster giving the growth curve value for each pixel</td>
<td><a href="https://drive.google.com/file/d/1yunkaYCV2LIdqej45C4F9ir5j1An0KKr" class="uri">https://drive.google.com/file/d/1yunkaYCV2LIdqej45C4F9ir5j1An0KKr</a></td>
</tr>
<tr class="odd">
<td>spuLocator</td>
<td>SpatRaster</td>
<td>Canada’s spatial units as polygon features with spatial unit IDs</td>
<td>CBM_defaults</td>
</tr>
<tr class="even">
<td>ecoLocator</td>
<td>SpatRaster</td>
<td>Canada’s ecozone as polygon features with ecozone IDs</td>
<td>CBM_defaults</td>
</tr>
<tr class="odd">
<td>disturbanceRasters</td>
<td>Character</td>
<td>Disturbance rasters for the study area for the duration of simulation</td>
<td>User provided, for SK: <a href="https://drive.google.com/file/d/12YnuQYytjcBej0_kdodLchPg7z9LygCt" class="uri">https://drive.google.com/file/d/12YnuQYytjcBej0_kdodLchPg7z9LygCt</a>
</td>
</tr>
<tr class="even">
<td>userDist</td>
<td>Data table</td>
<td>User provided disturbance table defining distubances and values in <code>disturbanceRasters</code>
</td>
<td>User provided, for SK: <a href="https://drive.google.com/file/d/1n4fXwUkX5GPyWJgr0QQx65roAIaxmcWJ" class="uri">https://drive.google.com/file/d/1n4fXwUkX5GPyWJgr0QQx65roAIaxmcWJ</a>
</td>
</tr>
</tbody>
</table></div>
<p>The default structure of <a href="https://SpaDES.PredictiveEcology.org">SpaDES</a> modules has the <code>.inputObjects</code> function, and in the <code>.inputObjects</code> function of <a href="https://github.com/PredictiveEcology/CBM_dataPrep_SK.git">CBM_dataPrep_SK</a>, we make use of the <code>reproducible::prepInputs</code> function which is an important part of the <a href="https://SpaDES.PredictiveEcology.org">SpaDES</a> toolkit (see the <a href="https://predictiveecology.org/training/_book/ModuleInputs.html%20manual%20for%20more%20details">SpaDES training</a>, tools that enable repeadability and reproducibility (<span class="citation">(<a href="#ref-McIntire2022"><strong>McIntire2022?</strong></a>)</span>). <a href="https://github.com/PredictiveEcology/CBM_dataPrep_SK.git">CBM_dataPrep_SK</a> falls back to the defaults for running the SK managed forests, unless alternative information is provided by the user. These defaults give an example users can developed their own scenarios on.</p>
<p>The study area is defined by the object <code>masterRaster</code>. This object can be provided directly as a raster, as per our example, or created from shape files or by other means by the user. Any R-code can replace current input processing examples in <a href="https://github.com/PredictiveEcology/CBM_dataPrep_SK.git">CBM_dataPrep_SK</a>. The characteristics (projection, resolution, etc.) of this <code>masterRaster</code> are transferred to all other rasters used in the simulation via the function <a href="https://predictiveecology.org/training/_book/prepInputs.html"><code>reproducible::prepInputs</code></a>. In our example, the age raster (<code>ageRaster</code>), the raster specifying where each growth curves is to be used (<code>gcIndexRaster</code>), location rasters that link back to the default parameters for Canada (<code>spuRaster</code>, <code>ecoRaster</code>), and the yearly disturbance rasters (provided as a list in this module <code>disturbanceRaster</code>, but process in the <code>annual</code> event of the <a href="https://github.com/PredictiveEcology/CBM_core.git">CBM_core</a> module using the function <a href="https://reproducible.predictiveecology.org/reference/postProcessTo.html"><code>reproducible::postProcess</code></a>, which is part of the <a href="https://predictiveecology.org/training/_book/prepInputs.html"><code>reproducible::prepInputs</code></a> function) are all matched to the <code>masterRaster</code>. Defaults parameters are expected from the <a href="https://github.com/PredictiveEcology/CBM_defaults.git">CBM_defaults</a> (<code>spinupSQL</code>, <code>species_tr</code>) and one table is provided <code>cbmAdmin</code>for user convenience. In addition to location (study area) and inventory information (age, here provided as a raster), the user is expected to provide: growth curves (<span class="math inline">\(m^3/ha\)</span>) that are linked to each pixel or stand (<code>userGcM3</code>), the leading species for each curve (<code>gcMeta</code>), and information about disturbances (<code>userDist</code>).</p>
</div>
<div id="module-functioning-1" class="section level2" number="3.3">
<h2>
<span class="header-section-number">3.3</span> Module functioning<a class="anchor" aria-label="anchor" href="#module-functioning-1"><i class="fas fa-link"></i></a>
</h2>
<p>Two central pieces are processed in <a href="https://github.com/PredictiveEcology/CBM_dataPrep_SK.git">CBM_dataPrep_SK</a>: the pixelGroups are created and the named disturbances are matched with disturbance matrices.</p>
<p><code>pixelGroup</code> are unique combinations of age, growth curve (which means species), spatial unit and ecozone. All pixels having identical age, growth curve, in the same spatial unit and ecozone share one <code>pixelGroup</code> number. The object <code>spatialDT</code> is the long-form where each simulated pixel has its own line, and <code>level3DT</code> lists only the pixel groups. In our example there are 1,347,529 pixels simulated which are grouped in 739 pixelGroups for actual processing. Parameters necessary for the <a href="https://github.com/PredictiveEcology/CBM_core.git">CBM_core</a> <code>spinup</code> are added to the <code>level3DT</code> object by using the output object <code>spinupSQL</code> from <a href="https://github.com/PredictiveEcology/CBM_defaults.git">CBM_defaults</a>.</p>
<p>The user identifies what disturbances occur on the landscape during the simulations. Our example points to a file (<code>userGcM3</code>) that has the disturbance name and description, matches that to a number on the raster we provide to identify disturbances (one per year since our simulations are yearly), and identifies if the disturbance is a whole stand disturbance or not. These disturbances need to be match to a disturbance matrix, which identifies the proportion of carbon transferred from one pool (source pool) to another pool (sink pool) when a disturbance occurs in that specific pixel of our study area. If something else then the defaults are used, the user will be prompted to select from a list of disturbance matrices available for the study area, for each spatial unit and ecozone combinations. These matrices are provided in the Canada-wide defaults and are region (spatial unit and ecozone) specific, these are read-in by <a href="https://github.com/PredictiveEcology/CBM_defaults.git">CBM_defaults</a> and available to the <a href="https://github.com/PredictiveEcology/CBM_dataPrep_SK.git">CBM_dataPrep_SK</a> module via the <a href="https://predictiveecology.org/training/_book/simList.html">simList()</a>. We provide an example of selection in our example. The user-prompts look like this:
<strong>MAYBE TO INSERT SCREEN SHOTS OF THE disturbance SELECTION PROCESS?</strong></p>
<p>There are 468 unique disturbance matrices identified in the defaults. Since root parameters and snag carbon transfer rates differ between hardwood and softwood in this model, each disturbance has a hardwood and a softwood instance, which means we really have 234 unique disturbances across Canada as defaults in this modelling system, one for hardwood and one for softwood. A user could add or modify the proportions transferred between pools to represent a disturbance (<strong>NOTE THAT THIS WOULD HAVE TO HAPPEN IN THE CSVs, and even then would that work? Does libcbm point to those files? what if we change them? QUESTION FOR SCOTT</strong>).
<strong>Add a section on how one would modify the disturbance matrices</strong></p>
<p>There are a series of helper functions in <a href="https://github.com/PredictiveEcology/CBMutils.git">CBMutils</a> to help users explore and navigate disturbance matrices: <a href="https://github.com/PredictiveEcology/CBMutils/tree/main/vignettes">spuDist</a> for extracting the disturbances in a specific spatial unit, <a href="https://github.com/PredictiveEcology/CBMutils/tree/main/vignettes">simDist()</a> which lists the distrubances used in a simulation, and <a href="https://github.com/PredictiveEcology/CBMutils/tree/main/vignettes">seeDist()</a> which pulls out the proportions from source to sink pools.</p>
<p>Because growth curves can be identified by strata, multiple columns can be used to identify growth curves using the <code>curveID</code> object. In our example, only one column is used, “gcids”.</p>
</div>
<div id="list-of-output-objects-1" class="section level2" number="3.4">
<h2>
<span class="header-section-number">3.4</span> List of output objects<a class="anchor" aria-label="anchor" href="#list-of-output-objects-1"><i class="fas fa-link"></i></a>
</h2>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="23%">
<col width="26%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th>Name</th>
<th>Class</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>allPixDT</td>
<td>Data table</td>
<td>Summary table of raster input data with 1 row for each <code>masterRaster</code> pixel</td>
</tr>
<tr class="even">
<td>spatialDT</td>
<td>Data table</td>
<td>Summary table of raster input data with 1 row for each <code>masterRaster</code> pixel that is not <code>NA</code>
</td>
</tr>
<tr class="odd">
<td>level3DT</td>
<td>Data table</td>
<td>Table associating pixel groups with key attributes</td>
</tr>
<tr class="even">
<td>speciesPixelGroup</td>
<td>Data table</td>
<td>Table connecting pixel groups to species IDs</td>
</tr>
<tr class="odd">
<td>ecozones</td>
<td>Numeric</td>
<td>Extracted ecozone IDs for each pixel group</td>
</tr>
<tr class="even">
<td>spatialUnits</td>
<td>Numeric</td>
<td>Extracted spatial unit IDs for each pixel group</td>
</tr>
<tr class="odd">
<td>realAges</td>
<td>Numeric</td>
<td>Extracted ages for each pixel group</td>
</tr>
<tr class="even">
<td>mySpuDmids</td>
<td>Data table</td>
<td>Summary table of possible CBM-CFS3 disturbances within study area spatial units</td>
</tr>
<tr class="odd">
<td>historicDMtype</td>
<td>Numeric</td>
<td>Historical disturbance type for each pixel group</td>
</tr>
<tr class="even">
<td>lastPassDMtype</td>
<td>Numeric</td>
<td>Last pass disturebance type for each pizel group</td>
</tr>
</tbody>
</table></div>
</div>
<div id="links-to-other-modules" class="section level2" number="3.5">
<h2>
<span class="header-section-number">3.5</span> Links to other modules<a class="anchor" aria-label="anchor" href="#links-to-other-modules"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><a href="https://github.com/PredictiveEcology/CBM_core">CBM_core</a></li>
<li><a href="https://github.com/PredictiveEcology/CBM_defaults">CBM_defaults</a></li>
<li><a href="https://github.com/PredictiveEcology/CBM_vol2biomass">CBM_vol2biomass</a></li>
</ul>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="cbm_defaults.html"><span class="header-section-number">2</span> CBM_defaults</a></div>
<div class="next"><a href="cbm_vol2biomass.html"><span class="header-section-number">4</span> CBM_vol2biomass</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#cbm_dataprep_sk"><span class="header-section-number">3</span> CBM_dataPrep_SK</a></li>
<li><a class="nav-link" href="#overview-1"><span class="header-section-number">3.1</span> Overview</a></li>
<li><a class="nav-link" href="#inputs"><span class="header-section-number">3.2</span> Inputs</a></li>
<li><a class="nav-link" href="#module-functioning-1"><span class="header-section-number">3.3</span> Module functioning</a></li>
<li><a class="nav-link" href="#list-of-output-objects-1"><span class="header-section-number">3.4</span> List of output objects</a></li>
<li><a class="nav-link" href="#links-to-other-modules"><span class="header-section-number">3.5</span> Links to other modules</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/camillegiuliano/CBMspadesManual/blob/master/modules/CBM_dataPrep_SK/CBM_dataPrep_SK.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/camillegiuliano/CBMspadesManual/edit/master/modules/CBM_dataPrep_SK/CBM_dataPrep_SK.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>CBM Spades Manual</strong>: v. 0.1" was written by Céline Boisvenue. It was last built on 26 June 2024.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
